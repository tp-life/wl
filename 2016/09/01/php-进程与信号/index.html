<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>php 进程与信号 | 走路人 |wokill</title>
  <meta name="author" content="wokill">
  
  <meta name="description" content="PHP进程与进程间的通讯一、引言
进程是具有独立功能的程序与关于某个数据集合的一次运行活动。换句话讲：在系统调度多个CPU时，一个程序的基本单元。进程对于大多数的语言都不是一个陌生的概念，作为”世界上最好的语言PHP”当然也例外

二、环境   php中的进程是以扩展的形式来完成。通过这些扩展，我们">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="php 进程与信号"/>
  <meta property="og:site_name" content="走路人 |wokill"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="走路人 |wokill" type="application/atom+xml">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
<link rel="stylesheet" href="/css/style.css">
  <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-368771XX-X']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>

<body>
  <header id="header" class='normal_mode'>
    <nav id="main-nav">
  <ul class='container'>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
  </header>
  <div id="content" class="container">
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
      <time datetime="2016-09-01T07:00:49.000Z"><a href="/2016/09/01/php-进程与信号/">Thu, Sep 1 2016, 3:00:49 pm</a></time>

  
    <h1 class="title">php 进程与信号</h1>
  



<div class="clear"></div>
      
    </header>
    <div class="entry">
      
        <h2 id="PHP进程与进程间的通讯"><a href="#PHP进程与进程间的通讯" class="headerlink" title="PHP进程与进程间的通讯"></a>PHP进程与进程间的通讯</h2><h3 id="一、引言"><a href="#一、引言" class="headerlink" title="一、引言"></a>一、引言</h3><blockquote>
<p>进程是具有独立功能的程序与关于某个数据集合的一次运行活动。换句话讲：在系统调度多个CPU时，一个程序的基本单元。进程对于大多数的语言都不是一个陌生的概念，作为”世界上最好的语言PHP”当然也例外</p>
</blockquote>
<h3 id="二、环境"><a href="#二、环境" class="headerlink" title="二、环境"></a>二、环境</h3><p>   php中的进程是以扩展的形式来完成。通过这些扩展，我们能够很轻松的完成进程的一系列动作。</p>
<ul>
<li>pcntl扩展：主要的进程扩展，完成进程创建于等待操作。</li>
<li>posix扩展：完成posix兼容机通用api,如获取进程id,杀死进程等。</li>
<li>sysvmsg扩展：实现system v方式的进程间通信之消息队列。</li>
<li>sysvsem扩展：实现system v方式的信号量。</li>
<li><p>sysvshm扩展：实现system v方式的共享内存。</p>
<p>这些扩展只能在linux/mac中使用，window下是不支持。最后建议php版本为5.5+。</p>
</li>
</ul>
<h3 id="三、简单的例子"><a href="#三、简单的例子" class="headerlink" title="三、简单的例子"></a>三、简单的例子</h3><p>  一个简单的PHP多进程例子，该例子中，一个子进程，一个父进程。子进程输出5次，退出程序。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">        <span class="comment">//获取当前的pid</span></div><div class="line">    $parent_id = posix_getpid();</div><div class="line"></div><div class="line">    <span class="keyword">echo</span> <span class="string">"parent procress pid :&#123;$parent_id&#125;\n"</span>;</div><div class="line"></div><div class="line">    $childrenList = [];</div><div class="line"></div><div class="line">    <span class="comment">//生成子进程</span></div><div class="line">    $pid = pcntl_fork();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($pid == <span class="number">-1</span>) &#123;</div><div class="line">        <span class="keyword">exit</span>(<span class="string">'子进程创建失败'</span>);</div><div class="line">    &#125; <span class="keyword">elseif</span> ($pid == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//创建成功子进程</span></div><div class="line"></div><div class="line">        $repnum = <span class="number">5</span>;</div><div class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>;$i &lt;= $repnum;++$i) &#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">"(&#123;$pid&#125;): child procress is running &#123;$i&#125;\n"</span>;</div><div class="line">            sleep(rand(<span class="number">1</span>, <span class="number">3</span>));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">exit</span>(<span class="string">'child procress id end!'</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//父进程执行</span></div><div class="line">        $childrenList[$pid] = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//等待子进程结束</span></div><div class="line">    pcntl_wait($status);</div><div class="line"></div><div class="line">    <span class="keyword">echo</span> <span class="string">"(&#123;$parent_id&#125;)main progress is end !"</span>;</div></pre></td></tr></table></figure></p>
<p>  完美，终于创建了一个子进程，一个父进程。完了么？没有，各个进程之间相互独立的，没有任何交集，使用范围严重受到现在。怎么办，哪就进程间通信(interprogress communication)呗。</p>
<h3 id="四、进程间的通信"><a href="#四、进程间的通信" class="headerlink" title="四、进程间的通信"></a>四、进程间的通信</h3><p>  通常linux中的进程通信方式有：消息队列、信号量、共享内存、信号、管道、socket。</p>
<h4 id="1、消息队列"><a href="#1、消息队列" class="headerlink" title="1、消息队列"></a>1、消息队列</h4><p>  消息队列是存放在内存中的一个队列。如下代码将创建3个生产者子进程，2个消费者子进程。这5个进程将通过消息队列通信。</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="comment">//posix_getpid() 获取当前进程pid</span></div><div class="line">  $parent_id = posix_getpid();</div><div class="line">  <span class="keyword">echo</span> <span class="string">"parent progress pid :(&#123;$parent_id&#125;)\n"</span>;</div><div class="line">  $childList=<span class="keyword">array</span>();</div><div class="line"></div><div class="line">  <span class="comment">//ftok返回一个以文件标识为id的队列通道，‘m’ 文件打开方式 return （int）</span></div><div class="line">  $id = ftok(<span class="keyword">__FILE__</span>,<span class="string">'m'</span>);</div><div class="line"></div><div class="line">  <span class="comment">//msg_get_queue  创建 一个队列</span></div><div class="line">  $msgQueue =msg_get_queue($id);</div><div class="line">  <span class="keyword">const</span> MSG_TYPE =<span class="number">1</span>;</div><div class="line"></div><div class="line">  <span class="comment">//生产者</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">producer</span><span class="params">()</span></span>&#123;</div><div class="line">    $pid = posix_getpid();</div><div class="line">    $repeatNum =<span class="number">5</span>;</div><div class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$repeatNum;$i++)&#123;</div><div class="line">        $str = <span class="string">"(&#123;$pid&#125;) child progress is create! (&#123;$i&#125;)\n"</span>;</div><div class="line">        <span class="comment">//发送数据</span></div><div class="line">        msg_send($msgQueue,MSG_TYPE,$str);</div><div class="line">        sleep(rand(<span class="number">1</span>,<span class="number">3</span>));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//消费者</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">consumer</span><span class="params">()</span></span>&#123;</div><div class="line">    $pid=posix_getpid();</div><div class="line">    $repeatNum=<span class="number">6</span>;</div><div class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$repeatNum;$i++)&#123;</div><div class="line">      <span class="comment">//读取数据 $message 为获取到的数据</span></div><div class="line">        msg_receive($msgQueue,MSG_TYPE,$msgType,<span class="number">1024</span>,$message);</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$message&#125; -- receive data : consumer (&#123;$pid) is destory\n"</span>;</div><div class="line">        sleep(rand(<span class="number">1</span>,<span class="number">3</span>));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//创建进程</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createProgress</span><span class="params">($callback)</span></span>&#123;</div><div class="line">    <span class="comment">//创建进程</span></div><div class="line">    $pid=pcntl_fork();</div><div class="line">    <span class="keyword">if</span>($pid == <span class="number">-1</span>)&#123;</div><div class="line">      <span class="keyword">exit</span>(<span class="string">"progress is create error \n"</span>);</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>($pid ==<span class="number">0</span>)&#123;</div><div class="line">      $pid =posix_getpid();</div><div class="line">      $callback();</div><div class="line">      <span class="keyword">exit</span>(<span class="string">"(&#123;$pid&#125;)"</span> child progress is end!\n);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">      <span class="keyword">return</span> $pid;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">3</span>;$i++)&#123;</div><div class="line">    $pid=createProgress(<span class="string">'producer'</span>);</div><div class="line">    $childList[$pid]=<span class="number">1</span>;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"producer child progress (&#123;$pid&#125;) is create!\n"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">2</span>;$i++)&#123;</div><div class="line">    $pid=createProgress(<span class="string">'consumer'</span>);</div><div class="line">    $childList[$pid]=<span class="number">1</span>;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"consumer child progress is create!\n"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">while</span>(!<span class="keyword">empty</span>($childList))&#123;</div><div class="line">    <span class="comment">//等待子进程执行结束</span></div><div class="line">    $childPid= pcntl_wait($status);</div><div class="line">    <span class="keyword">if</span>($childPid &gt; <span class="number">0</span>)&#123;</div><div class="line">      <span class="keyword">unset</span>($childList[$childPid]);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">echo</span> <span class="string">"(&#123;$parent_id&#125;) main progress is end!\n"</span>;</div></pre></td></tr></table></figure>
<p>  由于消息队列取数据是，只有一个进程能取到，所以不需要额外的锁或信号量。</p>
<h4 id="2、信号量与共享内存"><a href="#2、信号量与共享内存" class="headerlink" title="2、信号量与共享内存"></a>2、信号量与共享内存</h4>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  ```共享内存```：是系统在内存中开辟的一块公共的内存区域，任何一个进程都可以访问，在同一时刻，可以有多个进程访问该区域，为了保证数据的一致性，需要对该内存区域加锁或信号量。</div><div class="line">  以下，创建多个进程修改内存中的同一个值。</div><div class="line"></div><div class="line">```php</div><div class="line">      &lt;?php</div><div class="line">      本列函数说明：</div><div class="line">      int shm_attach(int key, int [memsize], int [perm])</div><div class="line">      函数说明：本函数用来打开或者建立共享内存空间。参数 key 为这部分的键。参＃数 memsize 可省略，表示所需最小的内存空间 (单位为 byte 位组)，默认值在 php3.ini 或 php.ini 中的 sysvshm.init_mem 配置，若无配置则为 10000 bytes。参数 perm 亦可省略，为该内存空间的使用权限，默认值为 666。返回值为共享内存的ID 值，可供程序使用。</div><div class="line"></div><div class="line">       int sem_get(int key, int [max_acquire] , int [perm]);</div><div class="line">       函数说明：</div><div class="line">       本函数用来取得 System V 系统信号 (semaphore) 的代码值。参数 key 为存取信号的键值。参数 max_acquire 可省略，默认值为 1，表示同时可取得的处理数目。参数 perm 可省略，表示该内存空间的控制权限，默认值为 0666。</div><div class="line"></div><div class="line">       int sem_acquire(int sem_identifier);</div><div class="line">       函数说明：</div><div class="line">       本函数用来捕获系统信号 (semaphore)。若捕捉信号的数量超过限度 (max_acquire)，则行程在捕捉时会先封锁 (block) 住信号。</div><div class="line"></div><div class="line">       int shm_put_var(int shm_identifier, int variable_key, mixed variable);</div><div class="line">       函数说明：</div><div class="line">       本函数可用来增加或者修改内存空间中变量值。参数 shm_identifier 为欲增加修改的共享内存 ID 值。参数 variable_key 为欲增加修改的变量名称键。参数 variable 为变量的内容，变量的类型可以是倍精确数 (double)、整数 (integer)、字符串 (string) 或者是数组 (array)。</div><div class="line"></div><div class="line">       bool shm_has_var(int shm_identifier, int variable_key);</div><div class="line">       函数说明：</div><div class="line">       验证参数 variable_key 的键是否存在.</div><div class="line"></div><div class="line">       mixed shm_get_var(int shm_identifier, int variable_key);</div><div class="line">       函数说明：</div><div class="line">       本函数可用来取得内存空间中指定的变量值。参数 shm_identifier 为欲取得的共享内存 ID 值。参数 variable_key 为欲取得的变量名称键。返回值即为指定变量键的值。</div><div class="line"></div><div class="line">       int shm_remove(int shm_identifier);</div><div class="line">       函数说明：</div><div class="line">       本函数用来清除共享内存空间的所有资料。参数 shm_identifier 即为欲停止部分的共享内存 ID 值。</div><div class="line"></div><div class="line">       int sem_release(int sem_identifier);</div><div class="line">       函数说明：</div><div class="line">       本函数用来释出调用行程捕获的系统信号 (semaphore)。成功则返回 true 值。</div><div class="line"></div><div class="line">       sem_remove(int sem_identifier)</div><div class="line">       函数说明：</div><div class="line">       本函数用来清楚信号量。参数 sem_identifier 即为欲停止信号量 ID 值。</div><div class="line"></div><div class="line"></div><div class="line">      #########################################################</div><div class="line"></div><div class="line"></div><div class="line">        $parent_id =posix_getpid();</div><div class="line">        echo &quot;parent progress &#123;$parent_id&#125; is start\n&quot;;</div><div class="line">        $childList=[];</div><div class="line">        $shm_id = ftok(__FILE__,&apos;m&apos;);</div><div class="line">        $sem_id = ftok(__FILE__,&apos;s&apos;);</div><div class="line">        //创建一块公共内存.</div><div class="line">        $shareMemray = shm_attach($shm_id);</div><div class="line">        //获取信号量</div><div class="line">        $sign=sem_get($sem_id);</div><div class="line">        //定义共享内存key （int）</div><div class="line">        const SHARE_KEY = 1;</div><div class="line"></div><div class="line">        function producer()&#123;</div><div class="line">          global $shareMemray;</div><div class="line">          global $sign;</div><div class="line">          $pid=posix_getpid();</div><div class="line">          $repeatNum=5;</div><div class="line">          for($i=0;$i&lt;$repeatNum;$i++)&#123;</div><div class="line">            //捕获信号</div><div class="line">            sem_acquire($sign);</div><div class="line">            if(!shm_has_var($shareMemray,SHARE_KEY))&#123;</div><div class="line">              shm_put_var($shareMemray,SHARE_KEY,0);</div><div class="line">              echo &quot;(&#123;$pid&#125;) count 0 \n&quot;;</div><div class="line">            &#125;else&#123;</div><div class="line">              $count=shm_get_var($shareMemray,SHARE_KEY);</div><div class="line">              ++$count;</div><div class="line">              shm_put_var($shareMemray,SHARE_KEY,$count);</div><div class="line">              echo &quot;(&#123;$pid&#125;) count &#123;$count&#125; \n&quot;</div><div class="line">            &#125;</div><div class="line">            //释放信号量</div><div class="line">            sem_release($sign);</div><div class="line">            sleep(rand(1,3));</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        function createProgress($callback)&#123;</div><div class="line">          $pid = pcntl_fork();</div><div class="line">          if($pid == -1)&#123;</div><div class="line">            exit(&quot;child progress is error \n&quot;);</div><div class="line">          &#125;else if($pid == 0)&#123;</div><div class="line">            $pid = posix_getpid();</div><div class="line">            $callback();</div><div class="line">            exit(&quot;(&#123;$pid&#125;) child progress is end!\n&quot;);</div><div class="line">          &#125;else&#123;</div><div class="line">            return $pid;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        for($i=0;$i&lt;3;$i++)&#123;</div><div class="line">          $pid = createProgress(&apos;producer&apos;);</div><div class="line">          $childList[$pid]=1;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        while(!empty($childList))&#123;</div><div class="line">          $childPid=pcntl_wait();</div><div class="line">          if($childPid &gt; 0)&#123;</div><div class="line">            unset($childList[$childPid]);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        shm_remove($shareMemray);</div><div class="line">        sem_remove($sign);</div><div class="line">        echo &quot;&#123;$parent_id&#125; main progress is end!\n&quot;;</div></pre></td></tr></table></figure>
<h4 id="3、信号"><a href="#3、信号" class="headerlink" title="3、信号"></a>3、信号</h4><p>信号是一种系统调用。通常我们用的kill命令就是发送某个信号给某个进程的。具体有哪些信号可以在liunx/mac中运行<figure class="highlight plain"><figcaption><span>-l```查看。下面这个例子中，父进程等待5秒钟，向子进程发送sigint信号。子进程捕获信号，掉信号处理函数处理。</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">```php</div><div class="line">    &lt;?php</div><div class="line">      $parent_id =posix_getpid();</div><div class="line">      echo &quot;&#123;$parent_id&#125; main progress is start\n&quot;;</div><div class="line"></div><div class="line">      function signHandle($sign)&#123;</div><div class="line">        $pid=posix_getpid();</div><div class="line">        echo &quot;(&#123;$pid&#125;) child progress is killed.no,my gold&quot;;</div><div class="line">        exit(1);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      $pid=pcntl_fork();</div><div class="line">      if($pid ==-1)&#123;</div><div class="line">        exit(&quot;create progress is error \n&quot;);</div><div class="line">      &#125;else if($pid ==0)&#123;</div><div class="line"></div><div class="line">        declare(ticks = 10 );</div><div class="line">        pcntl_signal(SIGINT,&apos;signHandle&apos;);</div><div class="line">        $pid=posix_getpid();</div><div class="line">        while(true)&#123;</div><div class="line">            echo &quot;&#123;$pid&#125; progress is running\n&quot;;</div><div class="line">            sleep(1);</div><div class="line">        &#125;</div><div class="line">          exit(&quot;(&#123;$pid&#125;) child progress is end \n&quot;);</div><div class="line"></div><div class="line">      &#125;else&#123;</div><div class="line">          sleep(5);</div><div class="line">          posix_kill($pid, SIGINT);</div><div class="line">          sleep(5);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      echo &quot;(&#123;$parent_id&#125;) main progress is end\n&quot;;</div></pre></td></tr></table></figure></p>
<h4 id="4、管道（有名管道）"><a href="#4、管道（有名管道）" class="headerlink" title="4、管道（有名管道）"></a>4、管道（有名管道）</h4><p>  管道是比较常用的多进程通信手段，管道分为无名管道与有名管道，无名管道只能用于具有亲缘关系的进程间通信，而有名管道可以用于同一主机上任意进程。这里只介绍有名管道。下面的例子，子进程写入数据，父进程读取数据。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$parent_id = posix_getpid();</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">"(&#123;$parent_id&#125;) main progress is start \n"</span>;</div><div class="line"></div><div class="line">$file = <span class="string">'/data/test.pipe'</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!file_exists($file)) &#123;</div><div class="line">    <span class="comment">//创建管道</span></div><div class="line">    <span class="keyword">if</span> (!posix_mkfifo($file, <span class="number">0664</span>)) &#123;</div><div class="line">        <span class="keyword">exit</span>(<span class="string">"create pipe error \n"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$pid = pcntl_fork();</div><div class="line"><span class="keyword">if</span> ($pid == <span class="number">-1</span>) &#123;</div><div class="line">    <span class="keyword">exit</span>(<span class="string">"Create child progress is error\n"</span>);</div><div class="line">&#125; <span class="keyword">elseif</span> ($pid == <span class="number">0</span>) &#123;</div><div class="line">    $file_r = fopen($file, <span class="string">'w'</span>);</div><div class="line">    $a = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        ++$a;</div><div class="line">        <span class="comment">//往管道里写数据</span></div><div class="line">        fwrite($file_r, <span class="string">"hello (&#123;$a&#125;) world\n"</span>);</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">exit</span>(<span class="string">"child end \n"</span>);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $file_r = fopen($file, <span class="string">'r'</span>);</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        <span class="comment">//读取管道里的数据</span></div><div class="line">        $data = fread($file_r, <span class="number">100</span>);</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$data&#125;\n"</span>;</div><div class="line">        sleep(rand(<span class="number">1</span>, <span class="number">2</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer>
      
          
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <span class="jiathis_txt">分享到：</span>
  <a class="jiathis_button_weixin">微信</a>
  <a class="jiathis_button_tsina">新浪微博</a>
  <a class="jiathis_button_renren">人人网</a>
  <a class="jiathis_button_qzone">QQ空间</a>
  <a class="jiathis_button_douban">豆瓣</a>
  <a class="jiathis_button_pocket">Pocket</a>
  <a href="http://www.jiathis.com/share?uid=901656" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=901656" charset="utf-8"></script>
<!-- JiaThis Button END -->

          <div class="clearfix"></div>
          <nav id="pagination">
  
  
    <a href="/2016/09/01/hello-world/" class="alignright next">Prev<i class="fa fa-long-arrow-right"></i></a>
  
  <div class="clearfix"></div>
</nav>
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Kommentare</h1>

  
      <!-- Duoshuo Comment BEGIN -->
<div class="ds-thread" data-thread-key="/2016/09/01/php-进程与信号/"></div>
<!-- Duoshuo Comment END -->
  
</section>



    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div>
  
  &copy; 2016 wokill
  
</div>
Powered by <a href="http://zespia.tw/hexo/" title="Hexo" target="_blank" rel="external">Hexo</a> and <a href="http://pages.github.com/" title="GitHub Pages" target="_blank" rel="external">GitHub Pages</a>

<div class="clearfix"></div></footer>
  
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>




    <script type="text/javascript">
        (function(){

            $(window).scroll(function(){

                var scrollTop = $(window).scrollTop();
                if ( scrollTop >200 ){
                    $("#main-nav").removeClass('normal_mode').addClass('top_mode');
                } else{
                    $("#main-nav").removeClass('top_mode').addClass('normal_mode');
                }

            });

        })();
    </script>



  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
  (function($){
    $('.fancybox').fancybox({
      'titlePosition': 'inside'
    });
  })(jQuery);
  </script>



    
    <script type="text/javascript">
      var duoshuoQuery = {short_name:"wokill"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = 'http://static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] 
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>



<script type="text/javascript">
  
  $(function(){

    $('.title').hover(
      function() {      
        $(this).stop().animate(
          {'marginLeft': '10px'}, 200
        );   
      }, 
      function() {       
        $(this).stop().animate({'marginLeft': '0px'}, 200);      
      
    });   

  });

</script>


</body>
</html>
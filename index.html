<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>走路人 |wokill</title>
  <meta name="author" content="wokill">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="走路人 |wokill"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="走路人 |wokill" type="application/atom+xml">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
<link rel="stylesheet" href="/css/style.css">
  <script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-368771XX-X']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>

<body>
  <header id="header" class='normal_mode'>
    <nav id="main-nav">
  <ul class='container'>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
      <li><a href="/随笔">随笔</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
  </header>
  <div id="content" class="container">
    <div id="cover">
	<div id="profile" alt="http://ww1.sinaimg.cn/large/6cea169fjw1edgyzma1xcj21kw16ohba.jpg">
		<a href="/">
			<div class="logo">
				<img src="/logo.png" alt="Profile Picture">
			</div>
			<div id="title">走路人 |wokill</div>
		</a>

		
		 <ul class="my-socials">
  
  <li>
  	<a href="https://github.com/wokill" class="github" target="_blank">
  		<i class="fa fa-github"></i>
  	</a>
  </li>
  
  <li>
  	<a href="http://weibo.com/u/5532555832" class="weibo" target="_blank">
  		<i class="fa fa-weibo"></i>
  	</a>
  </li>
  
 
</ul>
	</div>
</div>


  <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
      <time datetime="2016-09-01T07:00:49.000Z"><a href="/2016/09/01/php-进程与信号/">Thu, Sep 1 2016, 3:00:49 pm</a></time>

  
    <h1 class="title"><a href="/2016/09/01/php-进程与信号/">php 进程与信号</a></h1>
  



<div class="clear"></div>
      
    </header>
    <div class="entry">
      
        <h2 id="PHP进程与进程间的通讯"><a href="#PHP进程与进程间的通讯" class="headerlink" title="PHP进程与进程间的通讯"></a>PHP进程与进程间的通讯</h2><h3 id="一、引言"><a href="#一、引言" class="headerlink" title="一、引言"></a>一、引言</h3><blockquote>
<p>进程是具有独立功能的程序与关于某个数据集合的一次运行活动。换句话讲：在系统调度多个CPU时，一个程序的基本单元。进程对于大多数的语言都不是一个陌生的概念，作为”世界上最好的语言PHP”当然也例外</p>
</blockquote>
<h3 id="二、环境"><a href="#二、环境" class="headerlink" title="二、环境"></a>二、环境</h3><p>   php中的进程是以扩展的形式来完成。通过这些扩展，我们能够很轻松的完成进程的一系列动作。</p>
<ul>
<li>pcntl扩展：主要的进程扩展，完成进程创建于等待操作。</li>
<li>posix扩展：完成posix兼容机通用api,如获取进程id,杀死进程等。</li>
<li>sysvmsg扩展：实现system v方式的进程间通信之消息队列。</li>
<li>sysvsem扩展：实现system v方式的信号量。</li>
<li><p>sysvshm扩展：实现system v方式的共享内存。</p>
<p>这些扩展只能在linux/mac中使用，window下是不支持。最后建议php版本为5.5+。</p>
</li>
</ul>
<h3 id="三、简单的例子"><a href="#三、简单的例子" class="headerlink" title="三、简单的例子"></a>三、简单的例子</h3><p>  一个简单的PHP多进程例子，该例子中，一个子进程，一个父进程。子进程输出5次，退出程序。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">        <span class="comment">//获取当前的pid</span></div><div class="line">    $parent_id = posix_getpid();</div><div class="line"></div><div class="line">    <span class="keyword">echo</span> <span class="string">"parent procress pid :&#123;$parent_id&#125;\n"</span>;</div><div class="line"></div><div class="line">    $childrenList = [];</div><div class="line"></div><div class="line">    <span class="comment">//生成子进程</span></div><div class="line">    $pid = pcntl_fork();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($pid == <span class="number">-1</span>) &#123;</div><div class="line">        <span class="keyword">exit</span>(<span class="string">'子进程创建失败'</span>);</div><div class="line">    &#125; <span class="keyword">elseif</span> ($pid == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//创建成功子进程</span></div><div class="line"></div><div class="line">        $repnum = <span class="number">5</span>;</div><div class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>;$i &lt;= $repnum;++$i) &#123;</div><div class="line">            <span class="keyword">echo</span> <span class="string">"(&#123;$pid&#125;): child procress is running &#123;$i&#125;\n"</span>;</div><div class="line">            sleep(rand(<span class="number">1</span>, <span class="number">3</span>));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">exit</span>(<span class="string">'child procress id end!'</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//父进程执行</span></div><div class="line">        $childrenList[$pid] = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//等待子进程结束</span></div><div class="line">    pcntl_wait($status);</div><div class="line"></div><div class="line">    <span class="keyword">echo</span> <span class="string">"(&#123;$parent_id&#125;)main progress is end !"</span>;</div></pre></td></tr></table></figure></p>
<p>  完美，终于创建了一个子进程，一个父进程。完了么？没有，各个进程之间相互独立的，没有任何交集，使用范围严重受到现在。怎么办，哪就进程间通信(interprogress communication)呗。</p>
<h3 id="四、进程间的通信"><a href="#四、进程间的通信" class="headerlink" title="四、进程间的通信"></a>四、进程间的通信</h3><p>  通常linux中的进程通信方式有：消息队列、信号量、共享内存、信号、管道、socket。</p>
<h4 id="1、消息队列"><a href="#1、消息队列" class="headerlink" title="1、消息队列"></a>1、消息队列</h4><p>  消息队列是存放在内存中的一个队列。如下代码将创建3个生产者子进程，2个消费者子进程。这5个进程将通过消息队列通信。</p>
  <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="comment">//posix_getpid() 获取当前进程pid</span></div><div class="line">  $parent_id = posix_getpid();</div><div class="line">  <span class="keyword">echo</span> <span class="string">"parent progress pid :(&#123;$parent_id&#125;)\n"</span>;</div><div class="line">  $childList=<span class="keyword">array</span>();</div><div class="line"></div><div class="line">  <span class="comment">//ftok返回一个以文件标识为id的队列通道，‘m’ 文件打开方式 return （int）</span></div><div class="line">  $id = ftok(<span class="keyword">__FILE__</span>,<span class="string">'m'</span>);</div><div class="line"></div><div class="line">  <span class="comment">//msg_get_queue  创建 一个队列</span></div><div class="line">  $msgQueue =msg_get_queue($id);</div><div class="line">  <span class="keyword">const</span> MSG_TYPE =<span class="number">1</span>;</div><div class="line"></div><div class="line">  <span class="comment">//生产者</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">producer</span><span class="params">()</span></span>&#123;</div><div class="line">    $pid = posix_getpid();</div><div class="line">    $repeatNum =<span class="number">5</span>;</div><div class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$repeatNum;$i++)&#123;</div><div class="line">        $str = <span class="string">"(&#123;$pid&#125;) child progress is create! (&#123;$i&#125;)\n"</span>;</div><div class="line">        <span class="comment">//发送数据</span></div><div class="line">        msg_send($msgQueue,MSG_TYPE,$str);</div><div class="line">        sleep(rand(<span class="number">1</span>,<span class="number">3</span>));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//消费者</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">consumer</span><span class="params">()</span></span>&#123;</div><div class="line">    $pid=posix_getpid();</div><div class="line">    $repeatNum=<span class="number">6</span>;</div><div class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$repeatNum;$i++)&#123;</div><div class="line">      <span class="comment">//读取数据 $message 为获取到的数据</span></div><div class="line">        msg_receive($msgQueue,MSG_TYPE,$msgType,<span class="number">1024</span>,$message);</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$message&#125; -- receive data : consumer (&#123;$pid) is destory\n"</span>;</div><div class="line">        sleep(rand(<span class="number">1</span>,<span class="number">3</span>));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//创建进程</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createProgress</span><span class="params">($callback)</span></span>&#123;</div><div class="line">    <span class="comment">//创建进程</span></div><div class="line">    $pid=pcntl_fork();</div><div class="line">    <span class="keyword">if</span>($pid == <span class="number">-1</span>)&#123;</div><div class="line">      <span class="keyword">exit</span>(<span class="string">"progress is create error \n"</span>);</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>($pid ==<span class="number">0</span>)&#123;</div><div class="line">      $pid =posix_getpid();</div><div class="line">      $callback();</div><div class="line">      <span class="keyword">exit</span>(<span class="string">"(&#123;$pid&#125;)"</span> child progress is end!\n);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">      <span class="keyword">return</span> $pid;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">3</span>;$i++)&#123;</div><div class="line">    $pid=createProgress(<span class="string">'producer'</span>);</div><div class="line">    $childList[$pid]=<span class="number">1</span>;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"producer child progress (&#123;$pid&#125;) is create!\n"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">2</span>;$i++)&#123;</div><div class="line">    $pid=createProgress(<span class="string">'consumer'</span>);</div><div class="line">    $childList[$pid]=<span class="number">1</span>;</div><div class="line">    <span class="keyword">echo</span> <span class="string">"consumer child progress is create!\n"</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">while</span>(!<span class="keyword">empty</span>($childList))&#123;</div><div class="line">    <span class="comment">//等待子进程执行结束</span></div><div class="line">    $childPid= pcntl_wait($status);</div><div class="line">    <span class="keyword">if</span>($childPid &gt; <span class="number">0</span>)&#123;</div><div class="line">      <span class="keyword">unset</span>($childList[$childPid]);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">echo</span> <span class="string">"(&#123;$parent_id&#125;) main progress is end!\n"</span>;</div></pre></td></tr></table></figure>
<p>  由于消息队列取数据是，只有一个进程能取到，所以不需要额外的锁或信号量。</p>
<h4 id="2、信号量与共享内存"><a href="#2、信号量与共享内存" class="headerlink" title="2、信号量与共享内存"></a>2、信号量与共享内存</h4><p>  <code>信号量</code>：是系统提供的一种原子操作，一个信号量，同时只有你个进程能操作。一个进程获得了某个信号量，就必须被该进程释放掉。</p>
<p>  <code>共享内存</code>：是系统在内存中开辟的一块公共的内存区域，任何一个进程都可以访问，在同一时刻，可以有多个进程访问该区域，为了保证数据的一致性，需要对该内存区域加锁或信号量。<br>  以下，创建多个进程修改内存中的同一个值。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line">  $parent_id =posix_getpid();</div><div class="line">  <span class="keyword">echo</span> <span class="string">"parent progress &#123;$parent_id&#125; is start\n"</span>;</div><div class="line">  $childList=[];</div><div class="line">  $shm_id = ftok(<span class="keyword">__FILE__</span>,<span class="string">'m'</span>);</div><div class="line">  $sem_id = ftok(<span class="keyword">__FILE__</span>,<span class="string">'s'</span>);</div><div class="line">  <span class="comment">//创建一块公共内存.</span></div><div class="line">  $shareMemray = shm_attach($shm_id);</div><div class="line">  <span class="comment">//获取信号量</span></div><div class="line">  $sign=sem_get($sem_id);</div><div class="line">  <span class="comment">//定义共享内存key （int）</span></div><div class="line">  <span class="keyword">const</span> SHARE_KEY = <span class="number">1</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">producer</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">global</span> $shareMemray;</div><div class="line">    <span class="keyword">global</span> $sign;</div><div class="line">    $pid=posix_getpid();</div><div class="line">    $repeatNum=<span class="number">5</span>;</div><div class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$repeatNum;$i++)&#123;</div><div class="line">      <span class="comment">//捕获信号</span></div><div class="line">      sem_acquire($sign);</div><div class="line">      <span class="keyword">if</span>(!shm_has_var($shareMemray,SHARE_KEY))&#123;</div><div class="line">        shm_put_var($shareMemray,SHARE_KEY,<span class="number">0</span>);</div><div class="line">        <span class="keyword">echo</span> <span class="string">"(&#123;$pid&#125;) count 0 \n"</span>;</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line">        $count=shm_get_var($shareMemray,SHARE_KEY);</div><div class="line">        ++$count;</div><div class="line">        shm_put_var($shareMemray,SHARE_KEY,$count);</div><div class="line">        <span class="keyword">echo</span> <span class="string">"(&#123;$pid&#125;) count &#123;$count&#125; \n"</span></div><div class="line">      &#125;</div><div class="line">      <span class="comment">//释放信号量</span></div><div class="line">      sem_release($sign);</div><div class="line">      sleep(rand(<span class="number">1</span>,<span class="number">3</span>));</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createProgress</span><span class="params">($callback)</span></span>&#123;</div><div class="line">    $pid = pcntl_fork();</div><div class="line">    <span class="keyword">if</span>($pid == <span class="number">-1</span>)&#123;</div><div class="line">      <span class="keyword">exit</span>(<span class="string">"child progress is error \n"</span>);</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>($pid == <span class="number">0</span>)&#123;</div><div class="line">      $pid = posix_getpid();</div><div class="line">      $callback();</div><div class="line">      <span class="keyword">exit</span>(<span class="string">"(&#123;$pid&#125;) child progress is end!\n"</span>);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">      <span class="keyword">return</span> $pid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">3</span>;$i++)&#123;</div><div class="line">    $pid = createProgress(<span class="string">'producer'</span>);</div><div class="line">    $childList[$pid]=<span class="number">1</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">while</span>(!<span class="keyword">empty</span>($childList))&#123;</div><div class="line">    $childPid=pcntl_wait();</div><div class="line">    <span class="keyword">if</span>($childPid &gt; <span class="number">0</span>)&#123;</div><div class="line">      <span class="keyword">unset</span>($childList[$childPid]);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  shm_remove($shareMemray);</div><div class="line">  sem_remove($sign);</div><div class="line">  <span class="keyword">echo</span> <span class="string">"&#123;$parent_id&#125; main progress is end!\n"</span>;</div></pre></td></tr></table></figure>
<h4 id="3、信号"><a href="#3、信号" class="headerlink" title="3、信号"></a>3、信号</h4><p>信号是一种系统调用。通常我们用的kill命令就是发送某个信号给某个进程的。具体有哪些信号可以在liunx/mac中运行<code>kill -l</code>查看。下面这个例子中，父进程等待5秒钟，向子进程发送sigint信号。子进程捕获信号，掉信号处理函数处理。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">  $parent_id =posix_getpid();</div><div class="line">  <span class="keyword">echo</span> <span class="string">"&#123;$parent_id&#125; main progress is start\n"</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">signHandle</span><span class="params">($sign)</span></span>&#123;</div><div class="line">    $pid=posix_getpid();</div><div class="line">    <span class="keyword">echo</span> <span class="string">"(&#123;$pid&#125;) child progress is killed.no,my gold"</span>;</div><div class="line">    <span class="keyword">exit</span>(<span class="number">1</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  $pid=pcntl_fork();</div><div class="line">  <span class="keyword">if</span>($pid ==<span class="number">-1</span>)&#123;</div><div class="line">    <span class="keyword">exit</span>(<span class="string">"create progress is error \n"</span>);</div><div class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>($pid ==<span class="number">0</span>)&#123;</div><div class="line"></div><div class="line">    <span class="keyword">declare</span>(ticks = <span class="number">10</span> );</div><div class="line">    pcntl_signal(SIGINT,<span class="string">'signHandle'</span>);</div><div class="line">    $pid=posix_getpid();</div><div class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$pid&#125; progress is running\n"</span>;</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">      <span class="keyword">exit</span>(<span class="string">"(&#123;$pid&#125;) child progress is end \n"</span>);</div><div class="line"></div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">      sleep(<span class="number">5</span>);</div><div class="line">      posix_kill($pid, SIGINT);</div><div class="line">      sleep(<span class="number">5</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">echo</span> <span class="string">"(&#123;$parent_id&#125;) main progress is end\n"</span>;</div></pre></td></tr></table></figure></p>
<h4 id="4、管道（有名管道）"><a href="#4、管道（有名管道）" class="headerlink" title="4、管道（有名管道）"></a>4、管道（有名管道）</h4><p>  管道是比较常用的多进程通信手段，管道分为无名管道与有名管道，无名管道只能用于具有亲缘关系的进程间通信，而有名管道可以用于同一主机上任意进程。这里只介绍有名管道。下面的例子，子进程写入数据，父进程读取数据。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$parent_id = posix_getpid();</div><div class="line"></div><div class="line"><span class="keyword">echo</span> <span class="string">"(&#123;$parent_id&#125;) main progress is start \n"</span>;</div><div class="line"></div><div class="line">$file = <span class="string">'/data/test.pipe'</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!file_exists($file)) &#123;</div><div class="line">    <span class="comment">//创建管道</span></div><div class="line">    <span class="keyword">if</span> (!posix_mkfifo($file, <span class="number">0664</span>)) &#123;</div><div class="line">        <span class="keyword">exit</span>(<span class="string">"create pipe error \n"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$pid = pcntl_fork();</div><div class="line"><span class="keyword">if</span> ($pid == <span class="number">-1</span>) &#123;</div><div class="line">    <span class="keyword">exit</span>(<span class="string">"Create child progress is error\n"</span>);</div><div class="line">&#125; <span class="keyword">elseif</span> ($pid == <span class="number">0</span>) &#123;</div><div class="line">    $file_r = fopen($file, <span class="string">'w'</span>);</div><div class="line">    $a = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        ++$a;</div><div class="line">        <span class="comment">//往管道里写数据</span></div><div class="line">        fwrite($file_r, <span class="string">"hello (&#123;$a&#125;) world\n"</span>);</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">exit</span>(<span class="string">"child end \n"</span>);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    $file_r = fopen($file, <span class="string">'r'</span>);</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">        <span class="comment">//读取管道里的数据</span></div><div class="line">        $data = fread($file_r, <span class="number">100</span>);</div><div class="line">        <span class="keyword">echo</span> <span class="string">"&#123;$data&#125;\n"</span>;</div><div class="line">        sleep(rand(<span class="number">1</span>, <span class="number">2</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer>
      
        <div class="alignleft">
            <a href="/2016/09/01/php-进程与信号/#more" class="more-link"><i class="fa fa-chevron-right"></i>Read More</a>
        </div>
        
        
          <div class="alignright"> 
            <a href="http://wokill.cn/2016/09/01/php-进程与信号/#comment" class="comment-link">
              <i class="fa fa-comments"></i><span class="ds-thread-count" data-thread-key="/2016/09/01/php-进程与信号/">&nbsp;
              </span>
            </a>
          </div>
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>

<script src="/js/jquery.anystretch.min.js"></script>
<script src="/js/cover.js"></script>

    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div>
  
  &copy; 2016 wokill
  
</div>
Powered by <a href="http://zespia.tw/hexo/" title="Hexo" target="_blank" rel="external">Hexo</a> and <a href="http://pages.github.com/" title="GitHub Pages" target="_blank" rel="external">GitHub Pages</a>

<div class="clearfix"></div></footer>
  
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>




    <script type="text/javascript">
        (function(){

            $(window).scroll(function(){

                var scrollTop = $(window).scrollTop();
                if ( scrollTop >200 ){
                    $("#main-nav").removeClass('normal_mode').addClass('top_mode');
                } else{
                    $("#main-nav").removeClass('top_mode').addClass('normal_mode');
                }

            });

        })();
    </script>



  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript">
  (function($){
    $('.fancybox').fancybox({
      'titlePosition': 'inside'
    });
  })(jQuery);
  </script>



    
    <script type="text/javascript">
      var duoshuoQuery = {short_name:"wokill"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = 'http://static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] 
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>



<script type="text/javascript">
  
  $(function(){

    $('.title').hover(
      function() {      
        $(this).stop().animate(
          {'marginLeft': '10px'}, 200
        );   
      }, 
      function() {       
        $(this).stop().animate({'marginLeft': '0px'}, 200);      
      
    });   

  });

</script>


</body>
</html>